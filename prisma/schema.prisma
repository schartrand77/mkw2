generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  name         String?
  passwordHash String
  emailVerified Boolean  @default(false)
  isSuspended  Boolean  @default(false)
  isAdmin      Boolean  @default(false)
  discountPercent        Float   @default(0)
  isFriendsAndFamily     Boolean @default(false)
  friendsAndFamilyPercent Float   @default(0)
  models       Model[]
  likes        Like[]
  verificationTokens VerificationToken[]
  createdAt    DateTime @default(now())
  profile      Profile?
  badges       UserAchievement[]
  jobForms     JobForm[]
}

model Model {
  id             String   @id @default(cuid())
  title          String
  description    String?
  creditName     String?
  creditUrl      String?
  filePath       String
  viewerFilePath String?
  coverImagePath String?
  fileType       String
  unit           String   @default("mm")
  material       String   @default("PLA")
  volumeMm3      Float?
  sizeXmm        Float?
  sizeYmm        Float?
  sizeZmm        Float?
  priceUsd       Float?
  salePriceUsd   Float?
  salePriceIsFrom Boolean  @default(false)
  salePriceUnit   String?
  visibility     String   @default("public")
  downloads      Int      @default(0)
  likes          Int      @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  affiliateTitle String?
  affiliateUrl   String?
  videoEmbedId   String?
  images         ModelImage[]

  user   User   @relation(fields: [userId], references: [id])
  userId String

  modelTags ModelTag[]
  likesList Like[]
  featured  FeaturedModel?
  parts     ModelPart[]
}

model ModelImage {
  id        String   @id @default(cuid())
  modelId   String
  filePath  String
  caption   String?
  sortOrder BigInt   @default(0)
  createdAt DateTime @default(now())

  model Model @relation(fields: [modelId], references: [id], onDelete: Cascade)
}

model Tag {
  id      String     @id @default(cuid())
  name    String     @unique
  slug    String     @unique
  createdAt DateTime @default(now())
  modelTags ModelTag[]
}

model ModelTag {
  modelId String
  tagId   String
  model   Model @relation(fields: [modelId], references: [id])
  tag     Tag   @relation(fields: [tagId], references: [id])
  @@id([modelId, tagId])
}

model Like {
  userId  String
  modelId String
  createdAt DateTime @default(now())
  user    User  @relation(fields: [userId], references: [id])
  model   Model @relation(fields: [modelId], references: [id])
  @@id([userId, modelId])
}

model VerificationToken {
  id        String   @id @default(cuid())
  userId    String
  email     String
  token     String   @unique
  createdAt DateTime @default(now())
  expiresAt DateTime
  usedAt    DateTime?

  user      User     @relation(fields: [userId], references: [id])
}

model Profile {
  id               String   @id @default(cuid())
  slug             String   @unique
  bio              String?
  avatarImagePath  String?
  contactEmail     String?
  contactPhone     String?
  websiteUrl       String?
  socialTwitter    String?
  socialInstagram  String?
  socialTikTok     String?
  socialYoutube    String?
  socialBluesky    String?
  socialFacebook   String?
  shippingName     String?
  shippingAddress1 String?
  shippingAddress2 String?
  shippingCity     String?
  shippingState    String?
  shippingPostal   String?
  shippingCountry  String?
  createdAt        DateTime @default(now())

  user   User   @relation(fields: [userId], references: [id])
  userId String @unique
}

model FeaturedModel {
  modelId   String   @id
  position  Int      @default(0)
  createdAt DateTime @default(now())

  model Model @relation(fields: [modelId], references: [id], onDelete: Cascade)
}

model SiteConfig {
  id                       String   @id
  allowAnonymousUploads    Boolean? @default(true)
  directUploadUrl          String?
  printSpeedCm3PerHour     Float?
  energyUsdPerHour         Float?
  minimumPriceUsd          Float?
  extraHourlyUsdAfterFirst Float?
  plaPricePerKgUsd         Float?
  petgPricePerKgUsd        Float?
  fillFactor               Float?
  printerProfileKey        String?
  printerProfileOverrides  Json?
  createdAt                DateTime @default(now())
  updatedAt                DateTime @updatedAt
}

model ModelPart {
  id         String   @id @default(cuid())
  modelId    String
  name       String
  index      Int      @default(0)
  filePath   String
  previewFilePath String?
  volumeMm3  Float?
  sizeXmm    Float?
  sizeYmm    Float?
  sizeZmm    Float?
  priceUsd   Float?
  createdAt  DateTime @default(now())

  model Model @relation(fields: [modelId], references: [id], onDelete: Cascade)
}

model Achievement {
  id          String  @id @default(cuid())
  key         String  @unique
  name        String
  icon        String?
  description String?
  createdAt   DateTime @default(now())

  users UserAchievement[]
}

model UserAchievement {
  userId        String
  achievementId String
  awardedAt     DateTime @default(now())

  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievement Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)

  @@id([userId, achievementId])
}

model JobForm {
  id              String   @id @default(cuid())
  paymentIntentId String   @unique
  userId          String?
  customerEmail   String?
  lineItems       Json
  shipping        Json?
  metadata        Json?
  totalCents      Int
  currency        String
  status          String   @default("pending")
  webhookAttempts Int      @default(0)
  lastAttemptAt   DateTime?
  lastError       String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)
}
